{% extends "PittsTime/base.html" %}
{% load staticfiles %}

<head>
  <title>Blog Detail</title>

<style>
   /* Always set the map height explicitly to define the size of the div
    * element that contains the map. */
   #mapcanvas {
     height: 200px;
     width: 200px;
     visibility: visible;
   }
   /* Optional: Makes the sample page fill the window. */
    html, body, #mapcanvas {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
    }
 </style>

  <meta charset="utf-8">
  <!--[if IE]><meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'><![endif]-->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="">

  <!-- Google Fonts -->
  <link href='http://fonts.googleapis.com/css?family=Raleway:300,400%7COpen+Sans:400,400i,700%7CLibre+Baskerville:400i' rel='stylesheet'>

    <!-- Css -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">





</head>

{% block content%}
<input type="hidden" id="loc" value="{{blog.location}}">

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDMrTuTpobgB_i3a5GccqNQAzZXh9kWGpc&libraries=places"></script>

  <script type="text/javascript">

    function addComment(id) {

      console.log("commenting");

      var itemTextElement = $("#comment");
      if (itemTextElement.val() === '') {
        alert("Your comment is empty");
        return;
      }
      var itemTextValue  = encodeURIComponent(itemTextElement.val());
      barage.shoot(itemTextElement.val());

        $.ajax({
          url: "/PittsTime/add-comment",
          type: "POST",
          data: "comment_text="+itemTextValue+"&postID="+id+"&csrfmiddlewaretoken="+getCSRFToken(),
          dataType : "json",

          success: function(response) {

              if (response['error']) {
                  displayError(response.error);
              } else {
                  updateComment(response);
              }
          }
      });

    }

    function getCSRFToken() {
    var cookies = document.cookie.split(";");
    for (var i = 0; i < cookies.length; i++) {
        c = cookies[i].trim();
        if (c.startsWith("csrftoken=")) {
            return c.substring("csrftoken=".length, c.length);
        }
    }
    return "unknown";
  }

function updateComment(response) {
  console.log("updateComment");

  var clist = $("#clist");

  //console.log(response);

  $(response.comment).each(function() {
    {#barage.shoot(sanitize(this.fields.comment_text));#}
    clist.append("<li><div class=\"comment-body\"><img src=\"PittsTime/photo/" + response.user[0].fields"\" class=\"comment-avatar\" alt=\"\"><div class=\"comment-content\"><a href=\"/PittsTime/other_profile/"+response.user[0].pk+"\" > <span class=\"comment-author\">"+response.user[0].fields.first_name+" "+response.user[0].fields.last_name
      +"</span></a><span class=\"comment-date\">"+new Date(this.fields.create_time)+"</span><p>"+sanitize(this.fields.comment_text)+"</p></div></div></li>");

  });

  $("#comment").val('');
}

function sanitize(s) {
    // Be sure to replace ampersand first
    return s.replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;');
}

var map;

function initialize() {
    console.log("init");
    var body = document.body, html = document.documentElement;
    var height = Math.max(body.scrollHeight, body.offsetHeight, html.clientHeight, html.scrollHeight, html.offsetHeight);
    document.getElementById('mapcanvas').style.height = 300 + 'px';

  // Create a map centered in Pyrmont, Sydney (Australia).
  map = new google.maps.Map(document.getElementById('mapcanvas'), {
    center: {lat: 40.4406, lng:-79.9959},
    zoom: 9
  });

  searchLocation();

}

  </script>

    <div class="content-wrapper oh">

      <!-- Content -->
      <section class="content post-single pt-70 pt-mdm-60">
        <div class="container relative">
          <div class="row">
                <div class="entry-header col-md-4 post-content mb-30">
                  <!-- <a href="#" class="entry-category">{{blog.tag}}</a> -->
                  <h1 class="entry-title">{{blog.title}}</h1>
                </div>
          </div>
            <!-- post content -->
            <div class="col-md-4 post-content mb-30">


              <!-- large post -->

              <article class="entry-item large-post">


                <div class="entry-img">
                </div>

                <div class="entry-wrap">
                  <div class="entry">

                    <div class="entry-content">
                    <div id="barage_space" class="barage_space">
                      <div class="article">

                        {{blog.Blog_content|safe}}

                      </div>
                    </div>
                      <!-- tags -->

                      <div class="entry-tags tags mb-50 mt-40 clearfix">
                        {% for t in tags %}
                        <a href="{% url 'tag' t.id%}">{{t}}</a>
                        {% endfor %}
                      </div>


                      <div class="entry-meta-wrap clearfix">
                        <ul class="entry-meta">
                          <li class="entry-date">
                            <a href="#">{{blog.create_time}}</a>
                          </li>
<!--                           <li class="entry-comments">
                            <a href="blog-single.html">2 Comments</a>
                          </li> -->
                        </ul>


                      </div>

                      <!-- entry author -->
                      <div class="entry-author-box clearfix">
                        <div class="author-info">
                          <h6 class="author-name">
                          <span><h4>Author Profile:</h4></span><br>
                          {% if profile.bio_picture%}
                          <img id="id_user_picture" src="{% url 'photo' profile.id %}"  width="50px" height="50px">
                          {% else %}
                          <img src="https://upload.wikimedia.org/wikipedia/commons/1/1e/Default-avatar.jpg" width="50px" height="50px">
                          {% endif %}
                           &nbsp;&nbsp;&nbsp;
                            <a href="{% url 'other_profile' profile.id %}">{{blog.user.first_name}} {{blog.user.last_name}}</a></h6>
                          <p class="mb-0">
                            <span>{{profile.bio_text}}</span>
                          </p>
                        </div>


                      <!-- Comments -->
                      <div class="entry-comments mt-20">
                        <div class="heading-lines mb-30">
                          <h3 class="heading small">comments</h3>
                        </div>

                        <ul id="clist" class="comment-list">

                          {% for comment in comments %}
                          <li>
                            <div class="comment-body">
                              <img src="{% url 'photo' comment.user.profile.id %}" class="comment-avatar" alt="">
                              <div class="comment-content">
                                <a href="{% url 'other_profile' comment.user.profile.id %}"><span class="comment-author">{{comment.user.first_name}} {{comment.user.last_name}}</span></a>
                                <span class="comment-date">{{comment.create_time}}</span>
                                <p class="comment_text">{{comment.comment_text}}</p>
                              </div>
                            </div>
                          </li> <!-- end 3 comment -->
                          {% endfor %}
                        </ul>
                      </div> <!--  end comments -->

                      <!-- Leave a Comment -->
                      <div class="comment-form mt-60">
                        <div class="heading-lines mb-30">
                          <h3 class="heading small">Leave a Comment</h3>
                        </div>
                          <div class="row row-16">
                            <div class="col-md-12">
                              <textarea name="comment" id="comment" placeholder="Comment" rows="8"></textarea>
                            </div>
                          </div>

                          <input type="submit" class="btn btn-lg btn-color mt-20" value="Post Comment" id="submit-message" onclick="addComment({{blog.id}})">
                      </div>

                    </div>
                  </div>
                </div>
              </article> <!-- end large post -->
            </div> <!-- end col -->

            <!-- Sidebar -->
            <aside class="col-md-3 sidebar">
              <!-- Map -->
              <div style="width:100%; height:100%" class="widget newsletter">
                <div style="width:100%; height:100%" class="heading-lines">
                  <h3 class="widget-title heading">Map</h3>

                </div>
              </div>
              <div id="mapcanvas" width="250" height="250"></div>
                <!-- Music -->
              <div class="widget newsletter">
                <div class="heading-lines">
                  <h3 class="widget-title heading">Music</h3>
                  <iframe src="{{ blog.song_src }}" width="300" height="380" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
                </div>
              </div>

              <!-- Yelp -->
              <div class="widget newsletter">
                <div class="heading-lines">
                  <h3 class="widget-title heading">Yelp</h3>
                    {% if yelpInfo %}
                    <h4 id="yelp_name">{{ yelpInfo.name }}</h4>
                  <img id="yelp_image" src="{{ yelpInfo.image }}" alt="">
                    <p id="yelp_rating">Rating: {{ yelpInfo.rating }}</p>
                    <p id="yelp_location">Location: {{ yelpInfo.location }}</p>
                    <p id="yelp_phone">Phone: {{ yelpInfo.phone }}</p>
                    <p id="yelp_price">Price: {{ yelpInfo.price }}</p>
                    {% else %}
                        <h4>Sorry, Yelp information for this Location is not available</h4>
                    {% endif %}
                </div>

              </div>

              <!-- Categories -->
              <div class="widget categories">
                <div class="heading-lines">
                  <h3 class="widget-title heading">Categories</h3>
                </div>
                <ul class="list-dividers">
                  {% for i in interest %}
                  <li>
                    <a href="{% url 'tag' i.id%}">{{i.name}}</a>
                  </li>
                  {% endfor %}
                </ul>
              </div>

              <!-- Ad banner -->
              <div class="widget custom-ad-banner">
                <a href="#">
                  <!-- <img src="img/banner.jpg" alt=""> -->
                </a>
              </div>


              <!-- Recent Posts -->
              <div class="widget recent-posts">
                <div class="heading-lines">
                  <h3 class="widget-title heading">Recent Blogs</h3>
                </div>
                <div class="entry-list w-thumbs">
                  <ul class="posts-list list-dividers">
                    {% for b in recentblogs %}
                    <li class="entry-li">
                      <article class="post-small clearfix">
                        <div class="entry-img">
                          <a href="blog-single.html">
                            <!-- <img src="img/recent_1.jpg" alt=""> -->
                          </a>
                        </div>
                        <div class="entry">
                          <h3 class="entry-title"><a href="{% url 'blog-detail' b.id%}">{{b.title}}</a></h3>
                          <ul class="entry-meta list-inline">
                            <li class="entry-date">
                              <a href="#">{{b.create_time}}</a>
                            </li>
                          </ul>
                        </div>
                      </article>
                    </li>
                    {% endfor %}
                  </ul>
                </div>
              </div>
            </aside> <!-- end sidebar -->

          </div> <!-- end row -->
        </div> <!-- end container -->
      </section> <!-- end content -->


<!--       <div class="widget-social">
        <div class="social-icons text-center">
          <a href="#">
            <i class="fa fa-instagram"></i>
            <span>instagram</span>
          </a>
          <a href="#">
            <i class="fa fa-facebook"></i>
            <span>facebook</span>
          </a>
          <a href="#">
            <i class="fa fa-twitter"></i>
            <span>twitter</span>
          </a>
          <a href="#">
            <i class="fa fa-pinterest-p"></i>
            <span>pinterest</span>
          </a>
          <a href="#">
            <i class="fa fa-rss"></i>
            <span>rss</span>
          </a>
        </div>
      </div> -->


      <!-- Footer Type-1 -->
      <footer class="footer footer-type-1 bg-dark">
        <div class="bottom-footer">
          <div class="container">
            <div class="row">

              <div class="col-sm-12 copyright text-center">
                <span>
                  © 2019 WebApp Development • Team37
                </span>
              </div>

            </div>
          </div>
        </div>
      </footer> <!-- end footer -->


      <div id="back-to-top">
        <a href="#top"><i class="fa fa-angle-up"></i></a>
      </div>

    </div> <!-- end content wrapper -->


<script type="text/javascript">

function callback(results, status) {
          if (status == google.maps.places.PlacesServiceStatus.OK) {
            var marker = new google.maps.Marker({
              map: map,
              place: {
                placeId: results[0].place_id,
                location: results[0].geometry.location
              }
            });
          }
        }

        if ($("#loc").val() != "") {
            google.maps.event.addDomListener(window, 'load', initialize);
        }


          function searchLocation() {
            var location = $("#loc").val();
            var geocoder = new google.maps.Geocoder();
            geocoder.geocode( { 'address': location }, function(results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    map.setCenter(results[0].geometry.location);
                    map.setZoom(17);
                } 
                // else {
                //     alert("Could not find location: " + location);
                // }
            });

            var request = {
              location: map.getCenter(),
              radius: '100000',
              query: location
            };

            var service = new google.maps.places.PlacesService(map);
            service.textSearch(request, callback);
          }

  class Barrage {
      constructor(id) {
          this.domList = [];
          this.dom = document.querySelector('#' + id);
          {#console.log(this.dom);#}
          {#console.log(this);#}
          if (this.dom.style.position == '' || this.dom.style.position == 'static') {
              this.dom.style.position = 'relative';
          }
          this.dom.style.overflow = 'hidden';
          let rect = this.dom.getBoundingClientRect();
          this.domWidth = rect.right - rect.left;
          this.domHeight = rect.bottom - rect.top;
      }
      shoot(text) {
            let div = document.createElement('div');
            div.style.position = 'absolute';
            div.style.left = this.domWidth + 'px';
            div.style.top = (this.domHeight - 20) * +Math.random().toFixed(2) + 'px';
            div.style.whiteSpace = 'nowrap';
            div.style.color = '#' + Math.floor(Math.random() * 0xffffff).toString(16);
            div.innerText = text;
            div.style.fontSize = '150%';
            this.dom.appendChild(div);

            let roll = (timer) => {
                let now = +new Date();
                roll.last = roll.last || now;
                roll.timer = roll.timer || timer;
                let left = div.offsetLeft;
                let rect = div.getBoundingClientRect();
                if (left < (rect.left - rect.right)) {
                    this.dom.removeChild(div);
                } else {
                    if (now - roll.last >= roll.timer) {
                        roll.last = now;
                        left -= 3;
                        div.style.left = left + 'px';
                    }
                    requestAnimationFrame(roll);
                }
            }
            roll(50 * +Math.random().toFixed(2));
        }
  }
  let barage = new Barrage('barage_space');
    var x = [];
    comments = document.getElementsByClassName("comment_text");
    {#console.log(comments);#}
    for(i = 0; i< comments.length; i++){
        barage.shoot(comments[i].innerHTML);
    }


</script>
</body>
</html>

{% endblock %}
